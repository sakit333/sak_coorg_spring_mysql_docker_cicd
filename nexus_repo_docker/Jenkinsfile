pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['start', 'stop', 'terminate'],
            description: 'Choose what to do with the Nexus Repository container'
        )
    }

    environment {
        COMPOSE_FILE = 'nexus_repo_docker/docker-compose.yml'
        NETWORK_NAME = 'sak-network'
    }

    stages {
        stage('Validate Network') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "ğŸ” Checking if Docker network '${NETWORK_NAME}' exists..."
                sh '''
                if sudo docker network inspect ${NETWORK_NAME} >/dev/null 2>&1; then
                  echo "âœ… Network '${NETWORK_NAME}' already exists."
                else
                  echo "âš™ï¸  Network '${NETWORK_NAME}' not found. Creating it now..."
                  sudo docker network create ${NETWORK_NAME}
                fi
                '''
            }
        }

        stage('Build Nexus Image') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "ğŸ› ï¸ Building Nexus Repository image..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} build nexus"
            }
        }

        stage('Start Nexus Container') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "ğŸš€ Starting Nexus Repository container..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} up -d nexus"
            }
        }
        stage('Get the admin password for Nexus') {
            when { expression { params.ACTION == 'start' } }
            steps {
                script {
                    echo "â³ Waiting 2 minutes for Nexus to fully start..."
                    sleep time: 2, unit: 'MINUTES'

                    echo "ğŸ” Checking if Nexus container is running..."
                    def containerId = sh(
                        script: "sudo docker ps -qf 'name=nexus-repo'",
                        returnStdout: true
                    ).trim()

                    if (!containerId) {
                        echo "âš ï¸ Nexus container is not running. Skipping admin password retrieval."
                        return
                    }

                    echo "âœ… Nexus container is running. Retrieving admin password..."
                    def adminPassword = sh(
                        script: "sudo docker exec -it ${containerId} cat /nexus-data/admin.password 2>/dev/null || echo 'Password file not found'",
                        returnStdout: true
                    ).trim()

                    echo "\n================ Nexus Admin Credentials ================"
                    echo "ğŸ‘¤ Username: admin"
                    echo "ğŸ”‘ Password: ${adminPassword}"
                    echo "==========================================================\n"

                    input message: "ğŸ“‹ Copy the above password and click 'Proceed' when ready."
                }
            }
        }
        stage('Stop Nexus Container') {
            when { expression { params.ACTION == 'stop' } }
            steps {
                echo "ğŸ›‘ Stopping Nexus Repository container..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} stop nexus"
            }
        }

        stage('Terminate Nexus Container') {
            when { expression { params.ACTION == 'terminate' } }
            steps {
                echo "âŒ Removing Nexus Repository container, image, and volumes..."
                sh '''
                sudo docker-compose -f ${COMPOSE_FILE} down -v || true

                echo "ğŸ§¹ Cleaning up Nexus images..."
                sudo docker rmi -f sonatype/nexus3 || echo "âš ï¸ Base image not found, skipping..."
                sudo docker rmi -f nexus_repo_docker_nexus || echo "âš ï¸ Custom Nexus image not found, skipping..."
                '''
            }
        }

        stage('Show Nexus Status') {
            steps {
                echo "ğŸ“¦ Current Nexus Repository container status:"
                sh "sudo docker-compose -f ${COMPOSE_FILE} ps"
                echo "ğŸŒ Current Docker networks:"
                sh "sudo docker network ls | grep ${NETWORK_NAME} || true"
            }
        }
    }

    post {
        success {
            echo "âœ… Pipeline completed successfully for action: '${params.ACTION}'"
        }
        failure {
            echo "âŒ Pipeline failed during action: '${params.ACTION}'"
        }
        always {
            echo "â„¹ï¸ Pipeline finished. Check logs above for details."
        }
    }
}
